<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SessionFS - A session based VFS wrapper: src/shared_lib/libsessionfs.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="data-storage.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SessionFS - A session based VFS wrapper
   </div>
   <div id="projectbrief">Advanced Operating Systems and Virtualization - A.A. 2018/2019 Final Project</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('libsessionfs_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">libsessionfs.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Implementation of the userspace shared library.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;dlfcn.h&gt;</code><br />
<code>#include &lt;unistd.h&gt;</code><br />
<code>#include &lt;sys/types.h&gt;</code><br />
<code>#include &lt;sys/stat.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;fcntl.h&gt;</code><br />
<code>#include &lt;stdio.h&gt;</code><br />
<code>#include &lt;sys/ioctl.h&gt;</code><br />
<code>#include &lt;stdarg.h&gt;</code><br />
<code>#include &quot;<a class="el" href="libsessionfs_8h.html">libsessionfs.h</a>&quot;</code><br />
</div><div class="textblock"><div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Include dependency graph for libsessionfs.c:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="libsessionfs_8c__incl.png" border="0" usemap="#src_2shared__lib_2libsessionfs_8c" alt=""/></div>
<map name="src_2shared__lib_2libsessionfs_8c" id="src_2shared__lib_2libsessionfs_8c">
<area shape="rect" title="Implementation of the userspace shared library." alt="" coords="453,5,657,32"/>
<area shape="rect" title=" " alt="" coords="5,80,72,107"/>
<area shape="rect" title=" " alt="" coords="96,80,171,107"/>
<area shape="rect" title=" " alt="" coords="195,80,291,107"/>
<area shape="rect" title=" " alt="" coords="315,80,400,107"/>
<area shape="rect" title=" " alt="" coords="425,80,495,107"/>
<area shape="rect" title=" " alt="" coords="519,80,590,107"/>
<area shape="rect" title=" " alt="" coords="614,80,677,107"/>
<area shape="rect" title=" " alt="" coords="701,80,768,107"/>
<area shape="rect" title=" " alt="" coords="792,80,880,107"/>
<area shape="rect" title=" " alt="" coords="904,80,979,107"/>
<area shape="rect" href="libsessionfs_8h.html" title="Shared library header." alt="" coords="1003,80,1114,107"/>
<area shape="rect" title=" " alt="" coords="931,155,999,181"/>
<area shape="rect" title=" " alt="" coords="1023,155,1094,181"/>
<area shape="rect" href="device__sessionfs_8h.html" title="Properties of the devices necessary for the device implementation and the library that uses the devic..." alt="" coords="1119,155,1337,181"/>
<area shape="rect" title=" " alt="" coords="1115,229,1213,256"/>
<area shape="rect" title=" " alt="" coords="1237,229,1344,256"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a369266c24eacffb87046522897a570d5"><td class="memItemLeft" align="right" valign="top"><a id="a369266c24eacffb87046522897a570d5"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a369266c24eacffb87046522897a570d5">_GNU_SOURCE</a></td></tr>
<tr class="memdesc:a369266c24eacffb87046522897a570d5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enables RTLD_NEXT macro. <br /></td></tr>
<tr class="separator:a369266c24eacffb87046522897a570d5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a671e6b4489b01d7f3c63372b1b89b232"><td class="memItemLeft" align="right" valign="top"><a id="a671e6b4489b01d7f3c63372b1b89b232"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232">DEV_PATH</a>&#160;&#160;&#160;&quot;/dev/SessionFS_dev&quot;</td></tr>
<tr class="memdesc:a671e6b4489b01d7f3c63372b1b89b232"><td class="mdescLeft">&#160;</td><td class="mdescRight">The path of our device file. <br /></td></tr>
<tr class="separator:a671e6b4489b01d7f3c63372b1b89b232"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:afd57398a9a2356f13cf5663553ddaf1e"><td class="memItemLeft" align="right" valign="top"><a id="afd57398a9a2356f13cf5663553ddaf1e"></a>
typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#afd57398a9a2356f13cf5663553ddaf1e">orig_close_type</a>) (int filedes)</td></tr>
<tr class="memdesc:afd57398a9a2356f13cf5663553ddaf1e"><td class="mdescLeft">&#160;</td><td class="mdescRight">A typedef to aliases the function pointer to the libc <code>close</code>. <br /></td></tr>
<tr class="separator:afd57398a9a2356f13cf5663553ddaf1e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0858694d5a3751a361201f9bef715a9c"><td class="memItemLeft" align="right" valign="top"><a id="a0858694d5a3751a361201f9bef715a9c"></a>
typedef int(*&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a0858694d5a3751a361201f9bef715a9c">orig_open_type</a>) (const char *pathname, int flags)</td></tr>
<tr class="memdesc:a0858694d5a3751a361201f9bef715a9c"><td class="mdescLeft">&#160;</td><td class="mdescRight">A typedef that aliases the function pointer to the libc <code>open</code>. <br /></td></tr>
<tr class="separator:a0858694d5a3751a361201f9bef715a9c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a9ed16867a9394d9ccf1132194edae298"><td class="memItemLeft" align="right" valign="top">static&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a9ed16867a9394d9ccf1132194edae298">__attribute__</a> ((constructor))</td></tr>
<tr class="memdesc:a9ed16867a9394d9ccf1132194edae298"><td class="mdescLeft">&#160;</td><td class="mdescRight">A program constructor which saves the original value for the <code>open</code> and <code>close</code> symbols.  <a href="libsessionfs_8c.html#a9ed16867a9394d9ccf1132194edae298">More...</a><br /></td></tr>
<tr class="separator:a9ed16867a9394d9ccf1132194edae298"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aafbcde67669a1b96577e735ddebd8634"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#aafbcde67669a1b96577e735ddebd8634">close</a> (int fd)</td></tr>
<tr class="memdesc:aafbcde67669a1b96577e735ddebd8634"><td class="mdescLeft">&#160;</td><td class="mdescRight">Wraps the close determining if it must call the libc <code>close</code> or the SessionFS module.  <a href="libsessionfs_8c.html#aafbcde67669a1b96577e735ddebd8634">More...</a><br /></td></tr>
<tr class="separator:aafbcde67669a1b96577e735ddebd8634"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a90056fe0af1a3324f823b6d9424a1824"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a90056fe0af1a3324f823b6d9424a1824">device_shutdown</a> (void)</td></tr>
<tr class="memdesc:a90056fe0af1a3324f823b6d9424a1824"><td class="mdescLeft">&#160;</td><td class="mdescRight">Asks to shut down the <code>SessionFS_dev</code> device.  <a href="libsessionfs_8c.html#a90056fe0af1a3324f823b6d9424a1824">More...</a><br /></td></tr>
<tr class="separator:a90056fe0af1a3324f823b6d9424a1824"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4b449d2d0c21aa6c56e395ed6b302e94"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94">get_sess_path</a> (char *buf, int bufsize)</td></tr>
<tr class="memdesc:a4b449d2d0c21aa6c56e395ed6b302e94"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets the current session path.  <a href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94">More...</a><br /></td></tr>
<tr class="separator:a4b449d2d0c21aa6c56e395ed6b302e94"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a079d60801c18155ac2ec1707b56867fb"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a079d60801c18155ac2ec1707b56867fb">open</a> (const char *pathname, int flags,...)</td></tr>
<tr class="memdesc:a079d60801c18155ac2ec1707b56867fb"><td class="mdescLeft">&#160;</td><td class="mdescRight">Wraps the open determining if it must call the libc <code>open</code> or the SessionFS module.  <a href="libsessionfs_8c.html#a079d60801c18155ac2ec1707b56867fb">More...</a><br /></td></tr>
<tr class="separator:a079d60801c18155ac2ec1707b56867fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adda2f64738511a6b0b415abb239c83b9"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#adda2f64738511a6b0b415abb239c83b9">write_sess_path</a> (char *path)</td></tr>
<tr class="memdesc:adda2f64738511a6b0b415abb239c83b9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Changes the current session path.  <a href="libsessionfs_8c.html#adda2f64738511a6b0b415abb239c83b9">More...</a><br /></td></tr>
<tr class="separator:adda2f64738511a6b0b415abb239c83b9"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a798c4efbbbfe1f6f4567f14b9e362382"><td class="memItemLeft" align="right" valign="top"><a id="a798c4efbbbfe1f6f4567f14b9e362382"></a>
<a class="el" href="libsessionfs_8c.html#afd57398a9a2356f13cf5663553ddaf1e">orig_close_type</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a798c4efbbbfe1f6f4567f14b9e362382">orig_close</a></td></tr>
<tr class="memdesc:a798c4efbbbfe1f6f4567f14b9e362382"><td class="mdescLeft">&#160;</td><td class="mdescRight">Global variable that holds the function pointer for libc <code>close</code> <br /></td></tr>
<tr class="separator:a798c4efbbbfe1f6f4567f14b9e362382"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0098a24291249185933b54ee419ddaae"><td class="memItemLeft" align="right" valign="top"><a id="a0098a24291249185933b54ee419ddaae"></a>
<a class="el" href="libsessionfs_8c.html#a0858694d5a3751a361201f9bef715a9c">orig_open_type</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="libsessionfs_8c.html#a0098a24291249185933b54ee419ddaae">orig_open</a></td></tr>
<tr class="memdesc:a0098a24291249185933b54ee419ddaae"><td class="mdescLeft">&#160;</td><td class="mdescRight">Global variable that holds the function pointer for libc <code>open</code> <br /></td></tr>
<tr class="separator:a0098a24291249185933b54ee419ddaae"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of the userspace shared library. </p>
<p>Used to provide a trasparent interface to the userspace application, that can use the libc open and close functions, along with the <a class="el" href="device__sessionfs_8h.html#a6100134634836ba2329f3da20696ff46" title="Flag used to enable the Unix session semantic.">O_SESS</a> flag to work with sessions. To change session path instead, it can use the <a class="el" href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94" title="Gets the current session path.">get_sess_path()</a> and <a class="el" href="libsessionfs_8c.html#adda2f64738511a6b0b415abb239c83b9" title="Changes the current session path.">write_sess_path()</a> utility functions, to avoid the direct communication with the <code>SessionFS_dev</code> device. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a9ed16867a9394d9ccf1132194edae298"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9ed16867a9394d9ccf1132194edae298">&#9670;&nbsp;</a></span>__attribute__()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static __attribute__ </td>
          <td>(</td>
          <td class="paramtype">(constructor)&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>A program constructor which saves the original value for the <code>open</code> and <code>close</code> symbols. </p>
<dl class="section return"><dt>Returns</dt><dd>0 on success or -1 on error, setting <code>errno</code>.</dd></dl>
<p>We save the original open and close since the library needs to understand when it's necessary to use the char device and when the libc implementation must be used. To do so we save them we use the <code>dlsym</code> function and we define two new types to avoid using a function pointer directly: <code><a class="el" href="libsessionfs_8c.html#a0858694d5a3751a361201f9bef715a9c" title="A typedef that aliases the function pointer to the libc open.">orig_open_type</a></code> and <code><a class="el" href="libsessionfs_8c.html#afd57398a9a2356f13cf5663553ddaf1e" title="A typedef to aliases the function pointer to the libc close.">orig_close_type</a></code>, these are simple typedefs that wrap the function poitner for libc <code>open</code> and <code>close</code>. </p>

<p class="reference">References <a class="el" href="libsessionfs_8c.html#a798c4efbbbfe1f6f4567f14b9e362382">orig_close</a>, and <a class="el" href="libsessionfs_8c.html#a0098a24291249185933b54ee419ddaae">orig_open</a>.</p>

</div>
</div>
<a id="aafbcde67669a1b96577e735ddebd8634"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aafbcde67669a1b96577e735ddebd8634">&#9670;&nbsp;</a></span>close()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int close </td>
          <td>(</td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>fd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Wraps the close determining if it must call the libc <code>close</code> or the SessionFS module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">fd</td><td>file descriptor to deallocate, same as libc <code>open</code>'s <code>fildes</code>. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>0 on success, -1 on error, setting <code>errno</code> to indicate the error value.</dd></dl>
<p>To determine if libc close must be used, the file pathname is read from <code>/proc/self/fd</code>, then <code>readlink</code> is used to resolve the pathname and make it absolute, finally, if this pathname contains the <code>_incarnation_[pid]_</code> substring then it must be closed by issuing an ioctl with number <code><a class="el" href="device__sessionfs_8h.html#a93883829481d6ee1889e1d112de35539" title="The ioctl sequence number that idenfies the closing of a session.">IOCTL_SEQ_CLOSE</a></code> to the <code>SessionFS_dev</code> device. Otherwise the libc <code>close</code> is called. A <a class="el" href="structsess__params.html">sess_params</a> struct is used to pass parameters to the char device when necessary. After the device completes its operations libc <code>close</code> is called to remove the file descriptor and <code>remove</code> is called to delete the incarnation file from the disk. If the return value from the ioctl is <code>-ENODEV</code> the the device was temporarly disabled and the operation must be retried. </p>

<p class="reference">References <a class="el" href="device__sessionfs_8c.html#acf6a82c73e7a9d99293d9ce0b8837faf">dev</a>, <a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232">DEV_PATH</a>, <a class="el" href="device__sessionfs_8h.html#a93883829481d6ee1889e1d112de35539">IOCTL_SEQ_CLOSE</a>, <a class="el" href="libsessionfs_8c.html#a798c4efbbbfe1f6f4567f14b9e362382">orig_close</a>, <a class="el" href="libsessionfs_8c.html#a0098a24291249185933b54ee419ddaae">orig_open</a>, and <a class="el" href="device__sessionfs_8c.html#ade57e23a26963004ebf1cbcc05b825ed">sess_path</a>.</p>

<p class="reference">Referenced by <a class="el" href="userspace__test_8c.html#afa4dca6f8131bb0e05d21abae9f807d1">fork_test()</a>, <a class="el" href="userspace__test_8c.html#a1de5516a7893ff3ea277a8c976417bd7">func_test()</a>, <a class="el" href="libsessionfs_8c.html#a079d60801c18155ac2ec1707b56867fb">open()</a>, and <a class="el" href="userspace__test_8c.html#a4c29ab7f6b8f2458ef512e767c260daf">sess_change_test()</a>.</p>
<div id="dynsection-1" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-1-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-1-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-1-content" class="dyncontent" style="display:none;">
<div class="center"><img src="libsessionfs_8c_aafbcde67669a1b96577e735ddebd8634_icgraph.png" border="0" usemap="#libsessionfs_8c_aafbcde67669a1b96577e735ddebd8634_icgraph" alt=""/></div>
<map name="libsessionfs_8c_aafbcde67669a1b96577e735ddebd8634_icgraph" id="libsessionfs_8c_aafbcde67669a1b96577e735ddebd8634_icgraph">
<area shape="rect" title="Wraps the close determining if it must call the libc close or the SessionFS module." alt="" coords="396,56,452,83"/>
<area shape="rect" href="userspace__test_8c.html#afa4dca6f8131bb0e05d21abae9f807d1" title="Test file semantic with a session opened when forking." alt="" coords="137,5,217,32"/>
<area shape="rect" href="userspace__test_8c.html#a1de5516a7893ff3ea277a8c976417bd7" title="A general functionality test." alt="" coords="135,56,218,83"/>
<area shape="rect" href="libsessionfs_8c.html#a079d60801c18155ac2ec1707b56867fb" title="Wraps the open determining if it must call the libc open or the SessionFS module." alt="" coords="293,31,348,57"/>
<area shape="rect" href="userspace__test_8c.html#a4c29ab7f6b8f2458ef512e767c260daf" title="Test the semantic of sessions when the session path has changed." alt="" coords="108,107,245,133"/>
<area shape="rect" href="userspace__test_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="Testing of the kernel module." alt="" coords="5,56,60,83"/>
</map>
</div>

</div>
</div>
<a id="a90056fe0af1a3324f823b6d9424a1824"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a90056fe0af1a3324f823b6d9424a1824">&#9670;&nbsp;</a></span>device_shutdown()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int device_shutdown </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Asks to shut down the <code>SessionFS_dev</code> device. </p>
<p>To power down the device we only need to execute an ioctl with number <code><a class="el" href="device__sessionfs_8h.html#abb7e01390a965ee816c314ea918552d1" title="The ioctl sequence number that idenfies the request for the device shutdown.">IOCTL_SEQ_SHUTDOWN</a></code> and the devce will proceed accordingly. </p>

<p class="reference">References <a class="el" href="device__sessionfs_8c.html#acf6a82c73e7a9d99293d9ce0b8837faf">dev</a>, <a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232">DEV_PATH</a>, <a class="el" href="device__sessionfs_8h.html#abb7e01390a965ee816c314ea918552d1">IOCTL_SEQ_SHUTDOWN</a>, <a class="el" href="libsessionfs_8c.html#a798c4efbbbfe1f6f4567f14b9e362382">orig_close</a>, and <a class="el" href="libsessionfs_8c.html#a0098a24291249185933b54ee419ddaae">orig_open</a>.</p>

<p class="reference">Referenced by <a class="el" href="userspace__test_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main()</a>.</p>
<div id="dynsection-2" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-2-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-2-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-2-content" class="dyncontent" style="display:none;">
<div class="center"><img src="libsessionfs_8c_a90056fe0af1a3324f823b6d9424a1824_icgraph.png" border="0" usemap="#libsessionfs_8c_a90056fe0af1a3324f823b6d9424a1824_icgraph" alt=""/></div>
<map name="libsessionfs_8c_a90056fe0af1a3324f823b6d9424a1824_icgraph" id="libsessionfs_8c_a90056fe0af1a3324f823b6d9424a1824_icgraph">
<area shape="rect" title="Asks to shut down the SessionFS_dev device." alt="" coords="108,5,243,32"/>
<area shape="rect" href="userspace__test_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="Testing of the kernel module." alt="" coords="5,5,60,32"/>
</map>
</div>

</div>
</div>
<a id="a4b449d2d0c21aa6c56e395ed6b302e94"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4b449d2d0c21aa6c56e395ed6b302e94">&#9670;&nbsp;</a></span>get_sess_path()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int get_sess_path </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>bufsize</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets the current session path. </p>
<p>This function is a simple utility function that reads from the <code>SessionFS_dev</code> device, located at <code><a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232" title="The path of our device file.">DEV_PATH</a></code>, the current session path and places it in the buffer provided by the caller. </p>

<p class="reference">References <a class="el" href="device__sessionfs_8c.html#acf6a82c73e7a9d99293d9ce0b8837faf">dev</a>, <a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232">DEV_PATH</a>, <a class="el" href="libsessionfs_8c.html#a798c4efbbbfe1f6f4567f14b9e362382">orig_close</a>, and <a class="el" href="libsessionfs_8c.html#a0098a24291249185933b54ee419ddaae">orig_open</a>.</p>

<p class="reference">Referenced by <a class="el" href="userspace__test_8c.html#a8fb0a3225a9c074550158687a7f46cb2">change_sess_path()</a>, and <a class="el" href="libsessionfs_8c.html#a079d60801c18155ac2ec1707b56867fb">open()</a>.</p>
<div id="dynsection-3" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-3-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-3-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-3-content" class="dyncontent" style="display:none;">
<div class="center"><img src="libsessionfs_8c_a4b449d2d0c21aa6c56e395ed6b302e94_icgraph.png" border="0" usemap="#libsessionfs_8c_a4b449d2d0c21aa6c56e395ed6b302e94_icgraph" alt=""/></div>
<map name="libsessionfs_8c_a4b449d2d0c21aa6c56e395ed6b302e94_icgraph" id="libsessionfs_8c_a4b449d2d0c21aa6c56e395ed6b302e94_icgraph">
<area shape="rect" title="Gets the current session path." alt="" coords="483,54,597,80"/>
<area shape="rect" href="userspace__test_8c.html#a8fb0a3225a9c074550158687a7f46cb2" title="Use libsessionfs APIs to change the session path to path." alt="" coords="293,28,435,55"/>
<area shape="rect" href="libsessionfs_8c.html#a079d60801c18155ac2ec1707b56867fb" title="Wraps the open determining if it must call the libc open or the SessionFS module." alt="" coords="337,79,391,106"/>
<area shape="rect" href="userspace__test_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="Testing of the kernel module." alt="" coords="5,54,60,80"/>
<area shape="rect" href="userspace__test_8c.html#a4c29ab7f6b8f2458ef512e767c260daf" title="Test the semantic of sessions when the session path has changed." alt="" coords="108,28,245,55"/>
<area shape="rect" href="userspace__test_8c.html#afa4dca6f8131bb0e05d21abae9f807d1" title="Test file semantic with a session opened when forking." alt="" coords="137,79,217,106"/>
<area shape="rect" href="userspace__test_8c.html#a1de5516a7893ff3ea277a8c976417bd7" title="A general functionality test." alt="" coords="135,130,218,156"/>
</map>
</div>

</div>
</div>
<a id="a079d60801c18155ac2ec1707b56867fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a079d60801c18155ac2ec1707b56867fb">&#9670;&nbsp;</a></span>open()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int open </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>pathname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>...</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Wraps the open determining if it must call the libc <code>open</code> or the SessionFS module. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pathname</td><td>The pathname of the file to be opened, same usage an type of the libc <code>open</code>'s <code>pathname</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">flags</td><td>Flags to determine the file status flag and the access modes, same as the libc <code>open</code>'s <code>oflag</code>, however a possible flag is the <a class="el" href="device__sessionfs_8h.html#a6100134634836ba2329f3da20696ff46" title="Flag used to enable the Unix session semantic.">O_SESS</a> flag which enables the session semantic. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">mode</td><td>An optional parameter, which defines the permissions to set if a file must be created, (when <code>O_CREAT</code> is specified). </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>It will return a file descriptor if the operation is successful, or -1, setting <code>errno</code>.</dd></dl>
<p>This function will check for the presence of the <a class="el" href="device__sessionfs_8h.html#a6100134634836ba2329f3da20696ff46" title="Flag used to enable the Unix session semantic.">O_SESS</a> flag and if the path of the file to be opened has as a substring the session path.</p>
<p>If the checks are successful, the function will perform an ioctl call to the SessionFS kernel module, via the <code>SessionFS_dev</code> device, to open a new session for the given pathname. Otherwise, the function will call the libc implementation of the <code>open</code> systemcall.</p>
<p>To check that the given path has <code><a class="el" href="device__sessionfs__mod_8h.html#ade57e23a26963004ebf1cbcc05b825ed" title="Keeps the path to the directory in which session sematic is enabled (located in ::device_sessionfs....">sess_path</a></code> as a substring, <code>realpath()</code> is used, to convert the pathname to absolute. If <code>realpath()</code> fails with <code>ENOENT</code>, the path provided might be the relative path to a file that must be created, so the path of the current diretory is used as the file path.</p>
<p>To perform the ioctl the <code><a class="el" href="device__sessionfs_8h.html#ae2ad458a991106f7ca77b27d255735ca" title="The ioctl sequence number that indenfies the opening of a session.">IOCTL_SEQ_OPEN</a></code> number is used and struct <code><a class="el" href="structsess__params.html">sess_params</a></code> is filled and passed as an argument, to provide all the necessary informations to the device.</p>
<p>If the opened session is not valid, the function will call <code><a class="el" href="libsessionfs_8c.html#aafbcde67669a1b96577e735ddebd8634" title="Wraps the close determining if it must call the libc close or the SessionFS module.">close()</a></code> to remove the invalid session in a clean way and the function will fail with <code>EAGAIN</code>. </p>
<p>When creating a new file we need to call <code>creat</code> since we have the symbol only for the open with two parametrs.</p>

<p class="reference">References <a class="el" href="libsessionfs_8c.html#aafbcde67669a1b96577e735ddebd8634">close()</a>, <a class="el" href="device__sessionfs_8c.html#acf6a82c73e7a9d99293d9ce0b8837faf">dev</a>, <a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232">DEV_PATH</a>, <a class="el" href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94">get_sess_path()</a>, <a class="el" href="device__sessionfs_8h.html#ae2ad458a991106f7ca77b27d255735ca">IOCTL_SEQ_OPEN</a>, <a class="el" href="device__sessionfs_8h.html#a6100134634836ba2329f3da20696ff46">O_SESS</a>, <a class="el" href="libsessionfs_8c.html#a798c4efbbbfe1f6f4567f14b9e362382">orig_close</a>, <a class="el" href="libsessionfs_8c.html#a0098a24291249185933b54ee419ddaae">orig_open</a>, <a class="el" href="device__sessionfs_8c.html#ade57e23a26963004ebf1cbcc05b825ed">sess_path</a>, and <a class="el" href="device__sessionfs_8h.html#a572282928d464e8d81b724eefce60509">VALID_SESS</a>.</p>

<p class="reference">Referenced by <a class="el" href="userspace__test_8c.html#afa4dca6f8131bb0e05d21abae9f807d1">fork_test()</a>, <a class="el" href="userspace__test_8c.html#a1de5516a7893ff3ea277a8c976417bd7">func_test()</a>, and <a class="el" href="userspace__test_8c.html#a4c29ab7f6b8f2458ef512e767c260daf">sess_change_test()</a>.</p>
<div id="dynsection-4" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-4-trigger" src="closed.png" alt="+"/> Here is the call graph for this function:</div>
<div id="dynsection-4-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-4-content" class="dyncontent" style="display:none;">
<div class="center"><img src="libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_cgraph.png" border="0" usemap="#libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_cgraph" alt=""/></div>
<map name="libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_cgraph" id="libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_cgraph">
<area shape="rect" title="Wraps the open determining if it must call the libc open or the SessionFS module." alt="" coords="5,31,60,57"/>
<area shape="rect" href="libsessionfs_8c.html#aafbcde67669a1b96577e735ddebd8634" title="Wraps the close determining if it must call the libc close or the SessionFS module." alt="" coords="137,5,193,32"/>
<area shape="rect" href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94" title="Gets the current session path." alt="" coords="108,56,223,83"/>
</map>
</div>
<div id="dynsection-5" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-5-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-5-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-5-content" class="dyncontent" style="display:none;">
<div class="center"><img src="libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_icgraph.png" border="0" usemap="#libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_icgraph" alt=""/></div>
<map name="libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_icgraph" id="libsessionfs_8c_a079d60801c18155ac2ec1707b56867fb_icgraph">
<area shape="rect" title="Wraps the open determining if it must call the libc open or the SessionFS module." alt="" coords="293,56,348,83"/>
<area shape="rect" href="userspace__test_8c.html#afa4dca6f8131bb0e05d21abae9f807d1" title="Test file semantic with a session opened when forking." alt="" coords="137,5,217,32"/>
<area shape="rect" href="userspace__test_8c.html#a1de5516a7893ff3ea277a8c976417bd7" title="A general functionality test." alt="" coords="135,56,218,83"/>
<area shape="rect" href="userspace__test_8c.html#a4c29ab7f6b8f2458ef512e767c260daf" title="Test the semantic of sessions when the session path has changed." alt="" coords="108,107,245,133"/>
<area shape="rect" href="userspace__test_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="Testing of the kernel module." alt="" coords="5,56,60,83"/>
</map>
</div>

</div>
</div>
<a id="adda2f64738511a6b0b415abb239c83b9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adda2f64738511a6b0b415abb239c83b9">&#9670;&nbsp;</a></span>write_sess_path()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int write_sess_path </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Changes the current session path. </p>
<p>This function is a simple utility function that writes on the <code>SessionFS_dev</code> device, located at <code><a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232" title="The path of our device file.">DEV_PATH</a></code>, the content of the buffer provided by the user; before doing so however, it uses the <code>realpath()</code> function to make sure that the path provided to char device is an absolute path. </p>

<p class="reference">References <a class="el" href="device__sessionfs_8c.html#acf6a82c73e7a9d99293d9ce0b8837faf">dev</a>, <a class="el" href="libsessionfs_8c.html#a671e6b4489b01d7f3c63372b1b89b232">DEV_PATH</a>, <a class="el" href="libsessionfs_8c.html#a798c4efbbbfe1f6f4567f14b9e362382">orig_close</a>, and <a class="el" href="libsessionfs_8c.html#a0098a24291249185933b54ee419ddaae">orig_open</a>.</p>

<p class="reference">Referenced by <a class="el" href="userspace__test_8c.html#a8fb0a3225a9c074550158687a7f46cb2">change_sess_path()</a>.</p>
<div id="dynsection-6" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-6-trigger" src="closed.png" alt="+"/> Here is the caller graph for this function:</div>
<div id="dynsection-6-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-6-content" class="dyncontent" style="display:none;">
<div class="center"><img src="libsessionfs_8c_adda2f64738511a6b0b415abb239c83b9_icgraph.png" border="0" usemap="#libsessionfs_8c_adda2f64738511a6b0b415abb239c83b9_icgraph" alt=""/></div>
<map name="libsessionfs_8c_adda2f64738511a6b0b415abb239c83b9_icgraph" id="libsessionfs_8c_adda2f64738511a6b0b415abb239c83b9_icgraph">
<area shape="rect" title="Changes the current session path." alt="" coords="483,5,609,32"/>
<area shape="rect" href="userspace__test_8c.html#a8fb0a3225a9c074550158687a7f46cb2" title="Use libsessionfs APIs to change the session path to path." alt="" coords="293,5,435,32"/>
<area shape="rect" href="userspace__test_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="Testing of the kernel module." alt="" coords="5,5,60,32"/>
<area shape="rect" href="userspace__test_8c.html#a4c29ab7f6b8f2458ef512e767c260daf" title="Test the semantic of sessions when the session path has changed." alt="" coords="108,31,245,57"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_a63cefe7e6d9ee66e2cf48f8da64a394.html">shared_lib</a></li><li class="navelem"><a class="el" href="libsessionfs_8c.html">libsessionfs.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
