<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SessionFS - A session based VFS wrapper: Final Project Report</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="data-storage.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SessionFS - A session based VFS wrapper
   </div>
   <div id="projectbrief">Advanced Operating Systems and Virtualization - A.A. 2018/2019 Final Project</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Final Project Report </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Student Full Name:</b> Mattia Nicolella <b>Student ID:</b> 1707844</p>
<p>The following report will consist on a general introduction on the content of the project and several sections that will describe what each module implements. The detailed description of how the functions are implemented is provided in the file section of the documentation and it will be referenced during the report when these details are necessary.</p>
<p>The documentation, including this report, is generated by Doxygen and is provided in PDF and HTML format under the <code>docs</code> folder with the following filename: <code>Documentation</code>.</p>
<h1><a class="anchor" id="autotoc_md0"></a>
Introduction</h1>
<p>SessionFS is a virtual file system wrapper which allows an userspace application to use the Unix session semantics to operate on files.</p>
<p>To enable the Unix session semantic, the <code>open</code> and <code>close</code> system calls are wrapped by a userspace library (that must be directly included or at least preloaded) which will check if the invocation is a "normal" one or if uses the Unix session semantic.</p>
<p>If the invocation of the system call is not a "normal" one and thus uses the <code><a class="el" href="device__sessionfs_8h.html#a6100134634836ba2329f3da20696ff46" title="Flag used to enable the Unix session semantic.">O_SESS</a></code> custom flag with the "correct" path, the userspace library will execute an ioctl to an ad-hoc virtual character device, called <code>SessionFS_dev</code>, which will handle the invocation accordingly.</p>
<p>If the <code><a class="el" href="device__sessionfs_8h.html#a6100134634836ba2329f3da20696ff46" title="Flag used to enable the Unix session semantic.">O_SESS</a></code> flag is missing, or the path is not the one in which sessions are allowed the userspace library will use the libc version of the called function.</p>
<p>This allows the userspace application to trigger the usage of the Unix session semantic with the custom defined <code><a class="el" href="device__sessionfs_8h.html#a6100134634836ba2329f3da20696ff46" title="Flag used to enable the Unix session semantic.">O_SESS</a></code> flag when opening a file in the correct path and does not change the semantic for closing a file.</p>
<p>The module allows the semantic to be used inside a folder which can be specified or changed by the userspace application anytime (defaults to <code>/mnt</code>) without having effects on the already opened sessions. To change the session path is only necessary to write on the <code>SessionFS_dev</code> device file the new absolute path in which sessions will be enabled or using the <code><a class="el" href="libsessionfs_8c.html#adda2f64738511a6b0b415abb239c83b9" title="Changes the current session path.">write_sess_path()</a></code> function provided by the library. To get the current session path instead, a read on the <code>SessionFS_dev</code> device file is needed; as before, the userspace library provides the <code><a class="el" href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94" title="Gets the current session path.">get_sess_path()</a></code> to do so.</p>
<p>On kernel level, the type of ioctl received determines the operation to be executed by another module, the session manager. The session manger handles the creation of the new session and the closure of existing sessions. For each file which has active sessions it will enforce the Unix session semantic when adding and deleting incarnations. Adding an incarnation requires copying the information from the original file to an incarnation file which will have the same filenname but will end with <code>_incarnation_[pid]_[timestamp]</code>. Deleting an incarnation requires that the content of the incarnation file will be copied over the original file, overwriting its content; naturally creating an incarnation while another is being closed is not possible, so these operations will be serialized. Is possible, instead, to open concurrently multiple incarnations from the same original file.</p>
<p>The last module involved is the session info module, which will publish information on the active sessions via SysFS. In detail we have a pseudofile under <code>/sys/devices/virtual/SessionFS_dev</code> called <code>active_sessions</code> which contains the number of active incarnations. For each original file we have a folder in the same location as the previous pseudofile with the path of the original file where slashes are substituted by dashes (<code>/mnt/file</code> becomes <code>-mnt-file</code>); in this folder we have a pseudo file for each process that has an active incarnation on that original file. These pseudofiles have as the filename the pid of the process and when read they provide the name of the process with that pid.</p>
<p>Finally the session manager is also able to determine if there are invalid sessions, which are owned by dead processes and remove them.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
User Space Library</h1>
<p>This library (<a class="el" href="libsessionfs_8c.html" title="Implementation of the userspace shared library.">libsessionfs.c</a>) wraps the <code>open</code> and <code>close</code> systemcalls to determine which semantic is used during invocation if the<code>SessionFS_dev</code> device must bu used to communicate with the kernel module.</p>
<p>Additionally, the library exposes two utility functions, via its header, <a class="el" href="libsessionfs_8h.html" title="Shared library header.">libsessionfs.h</a>: <code><a class="el" href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94" title="Gets the current session path.">get_sess_path()</a></code>, <code><a class="el" href="libsessionfs_8c.html#adda2f64738511a6b0b415abb239c83b9" title="Changes the current session path.">write_sess_path()</a></code>, to change the folder in which session are enabled without making the userspace application communicate directly with the <code>SessionFS_dev</code> device. The last utility function exported is <code><a class="el" href="libsessionfs_8c.html#a90056fe0af1a3324f823b6d9424a1824" title="Asks to shut down the SessionFS_dev device.">device_shutdown()</a></code> which asks the device to disable itself and unlock the module.</p>
<p>The library is composed by:</p><ul>
<li><code><a class="el" href="libsessionfs_8c.html#a9ed16867a9394d9ccf1132194edae298" title="A program constructor which saves the original value for the open and close symbols.">__attribute__((constructor))</a> init_method()</code>: constructor used to save the libc <code>open</code> and <code>close</code>;</li>
<li><code><a class="el" href="libsessionfs_8c.html#a079d60801c18155ac2ec1707b56867fb" title="Wraps the open determining if it must call the libc open or the SessionFS module.">open()</a></code>: wraps the libc <code>open</code> function;</li>
<li><code><a class="el" href="libsessionfs_8c.html#aafbcde67669a1b96577e735ddebd8634" title="Wraps the close determining if it must call the libc close or the SessionFS module.">close()</a></code>: wraps the libc <code>close</code> function;</li>
<li><code><a class="el" href="libsessionfs_8c.html#a4b449d2d0c21aa6c56e395ed6b302e94" title="Gets the current session path.">get_sess_path()</a></code>: returns the current session path;</li>
<li><code><a class="el" href="libsessionfs_8c.html#adda2f64738511a6b0b415abb239c83b9" title="Changes the current session path.">write_sess_path()</a></code>: changes the current session path;</li>
<li><code><a class="el" href="libsessionfs_8c.html#a90056fe0af1a3324f823b6d9424a1824" title="Asks to shut down the SessionFS_dev device.">device_shutdown()</a></code>: ask to the device to disable itself and unlock the module.</li>
</ul>
<p>The userspace library is not srictly necessary, but makes the communication with the <code>SessionFS_dev</code> device almost transparent from the perspective of the userspace program.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Kernel-Level Implementation</h1>
<p>At kernel level there are several modules to implement the subsystem and several data structures to keep information about the opened sessions, which will be described in this section, referencing their documentation.</p>
<p>The subsystem is divided in four submodules:</p>
<ul>
<li><em>Module Configuration</em>: Contains the kernel module configuration.</li>
<li><em>Character Device</em>: Contains the <code>SessionFS_dev</code> device implementation.</li>
<li><em>Session Manager</em>: Implements operations on the sessions.</li>
<li><em>Session Information</em>: Publishes sessions information under <code>SessionFS_dev</code> device kobject via SysFS.</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Kernel-Level Data Structures Specification</h2>
<p>The data structures are described following the dependencies of each submodule, starting from the <em>Module Configuration</em> submodule.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
Module Configuration</h3>
<p>On the kernel module there is only a module parameter, which is the session path of the device <code><a class="el" href="device__sessionfs__mod_8h.html#ade57e23a26963004ebf1cbcc05b825ed" title="Keeps the path to the directory in which session sematic is enabled (located in ::device_sessionfs....">sess_path</a></code>, to offer an alternative path for reading it.</p>
<h3><a class="anchor" id="autotoc_md5"></a>
Character Device</h3>
<p>There are some global variables in the <em>Character Device</em> submodule, used to store information on the device. Then there are two headers, since we need to separate the information available for the kernel module, contained in <a class="el" href="device__sessionfs__mod_8h.html" title="Device properties needed to the kernel module, component of the Character Device submodule.">device_sessionfs_mod.h</a>, from the device information, which is available to the shared library, contained in <a class="el" href="device__sessionfs_8h.html" title="Properties of the devices necessary for the device implementation and the library that uses the devic...">device_sessionfs.h</a>. In <a class="el" href="device__sessionfs_8h.html" title="Properties of the devices necessary for the device implementation and the library that uses the devic...">device_sessionfs.h</a> the <code><a class="el" href="structsess__params.html">sess_params</a></code> struct is used to pass parameters between userspace and kernel during ioctls.</p>
<p>It's important to note that in the device implementation (<a class="el" href="device__sessionfs_8c.html" title="Implementation of the virtual character device that will handle sessions, component of the Character ...">device_sessionfs.c</a>) there are two global atomic variables:</p><ul>
<li><code><a class="el" href="device__sessionfs_8c.html#a05060cdcff0a75b56ac633165c824f1f" title="Indicates that the device must not be used since is being removed.">device_status</a></code>: which determines if the device is disabled and it being removed.</li>
<li><code><a class="el" href="device__sessionfs_8c.html#a9b74fe6d4d3e403eb54f84a6310bfbf8" title="Refcount of the processes that are using the device.">refcount</a></code>: which keeps the information on the number of processes that are actually using the device.</li>
</ul>
<p>As global variables there are also the session path (<code><a class="el" href="device__sessionfs__mod_8h.html#ade57e23a26963004ebf1cbcc05b825ed" title="Keeps the path to the directory in which session sematic is enabled (located in ::device_sessionfs....">sess_path</a></code>), the read-write lock for the session path (<code><a class="el" href="device__sessionfs_8c.html#a569cfaa35009e80bc8a86dcf868e9e2a" title="Lock that protects the session path from concurrent accesses.">dev_lock</a></code>) and the length of the string stored in <code><a class="el" href="device__sessionfs__mod_8h.html#ade57e23a26963004ebf1cbcc05b825ed" title="Keeps the path to the directory in which session sematic is enabled (located in ::device_sessionfs....">sess_path</a></code> as <code><a class="el" href="device__sessionfs_8c.html#a0795adbd1769bd5aa787af11b811c556" title="Length of the of the path string.">path_len</a></code>.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
Session Manager</h3>
<p>As the <em>Character Device</em>, the <em>Session Manager</em> has two headers, one which exports its APIs, <a class="el" href="session__manager_8h.html" title="APIs used to interact with the session manger, component of the Session Manager submodule.">session_manager.h</a>, and another, <a class="el" href="session__types_8h.html">session_types.h</a>, which contains the definition of the objects used by the session manager.</p>
<p>The objects used by this submodule are:</p>
<ul>
<li><code><a class="el" href="structsession__rcu.html" title="RCU item that contains a session.">session_rcu</a></code>: Contains a pointer to a <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> object and is used in the rculist <code><a class="el" href="session__manager_8c.html#a16d321e233eeb27c5fa65d1b7519477e" title="List of the active session(s).">sessions</a></code>.</li>
<li><code><a class="el" href="structsession.html" title="General information on a session.">session</a></code>: Represents an original file and its incarnations.</li>
<li><code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code>: An incarnation file, related to an original file, so to a <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> object.</li>
<li><code><a class="el" href="structsess__info.html" title="Infromations on a session used by SysFS.">sess_info</a></code>: Used to publish informations on a struct <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> via SysFS.</li>
</ul>
<p>The <em>Session Manager</em> implementation (<a class="el" href="session__manager_8c.html" title="Implementation of the Session Manager submodule.">session_manager.c</a>), has also two global variables: an RCU list called <code><a class="el" href="session__manager_8c.html#a16d321e233eeb27c5fa65d1b7519477e" title="List of the active session(s).">sessions</a></code>, which contains all the information about all the sessions and it's protected by a spinlock, <code><a class="el" href="session__manager_8c.html#a8969353f4c2bc47763ade4fc6cf466dc" title="Spinlock used to update the list of the active session(s)">sessions_lock</a></code>, the other global variable.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
Session Information</h3>
<p>This submodule is the one responsible to publish information in the <code>SessionFS_dev</code> folder via SysFS, it exposes its APIs to the <em>Session Manager</em> submodule via <a class="el" href="session__info_8h.html" title="Handles the kobjects for the session manager, part of the Session Information submodule....">session_info.h</a> and uses the data structures defined in <a class="el" href="session__types_8h.html">session_types.h</a> among some global variables used in <a class="el" href="session__info_8c.html" title="Implementation of the Session Information submodule.">session_info.c</a>:</p>
<ul>
<li><code><a class="el" href="session__info_8c.html#a7bde0d05ae26eff4674466c5e0f30a24" title="The number of opened sessions.">sessions_num</a></code>: The variable holding the number of active sessions.</li>
<li><code><a class="el" href="session__info_8c.html#a19aa300cfa380f18e8e12a19a4beb515" title="The device kobject provided during init_info().">dev_kobj</a></code>: The <code>SessionFS_dev</code> kernel object, provided during the initialization of this subsystem.</li>
<li><code><a class="el" href="session__info_8c.html#a96baf900f57fd912e3c3fd6619d4eefd" title="The kernel attribute that will contain the number of open sessions.">kattr</a></code>: The kernel attribute of <code>SessionFS_dev</code> which represents the number of active sessions.</li>
</ul>
<h2><a class="anchor" id="autotoc_md8"></a>
Kernel-Level Subsystem Implementation</h2>
<p>This section contains the description about the implementation on the functions in each submodule, referencing their documentation, where the description of their implementation is more accurate.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Module Configuration</h3>
<p>The <em>Module Configuration</em> (<a class="el" href="module_8c.html" title="Module configuration, component of the Module Configuration submodule.">module.c</a>) contains only two functions, along with the macros used to add <code><a class="el" href="device__sessionfs__mod_8h.html#ade57e23a26963004ebf1cbcc05b825ed" title="Keeps the path to the directory in which session sematic is enabled (located in ::device_sessionfs....">sess_path</a></code> as a read-only module paramenter.</p>
<p>The functions used in this module are:</p><ul>
<li><code><a class="el" href="module_8c.html#af4b79167ea5472e999750f3f28dd0f74" title="Loads the device when the kernel module is loaded in the kernel.">sessionFS_load()</a></code>: which initializes the <code>SessionFS_dev</code> device and is used during the module initialization, as specified by <code><a class="el" href="module_8c.html#ab0040cb13370497aefd8e368f1c49faa" title="Specification of the module init function.">module_init()</a></code>.</li>
<li><code><a class="el" href="module_8c.html#abd810a6f947c3b87a782a9aad746eef3">sessionFS_unload()</a></code>: which releases the <code>SessionFS_dev</code> device and is used during the module exit, as specified by <code><a class="el" href="module_8c.html#a02b2f06e7d71fe8091a239b25581c533" title="Specification of the module cleanup function.">module_exit()</a></code>.</li>
</ul>
<p>The module exit function cannot be called anytime, because the module will be locked when in use by the <code>SessionFS_dev</code> device which adds a dependency on it.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Character Device</h3>
<p>The <em>Character Device</em> submodule (<a class="el" href="device__sessionfs_8c.html" title="Implementation of the virtual character device that will handle sessions, component of the Character ...">device_sessionfs.c</a>) implements the <code>SessionFS_dev</code> device and it's invoked by the <em>Module Configuration</em> submodule when the module is loaded, where <code><a class="el" href="device__sessionfs_8c.html#a88bd4adb20dc9040ae78f5b4036b61ab" title="Device initialization and registration.">init_device()</a></code> is called and during the module unloading, where <code><a class="el" href="device__sessionfs_8c.html#ac7ee6e3825fe5ac77a75a42e4da28843" title="Releases the device and frees the used memory.">release_device()</a></code> is called. These two functions are responsible of the device initialization and the device cleanup. It's important to note that when the device is initialized the kernel module is locked, using <code>try_get_module()</code>, which adds a dependency to the the kernel module, locking it.</p>
<p>When the <code>SessionFS_dev</code> device has been initialized it can be called from userspace applications, by issuing a read, write or ioctl operation.</p>
<p>When a read operation is issued the <code><a class="el" href="device__sessionfs_8c.html#a17d464f6af03df59ad31c4573d0ab986" title="Get the path in which sessions are enabled.">device_read()</a></code> function is called, and the content of <code><a class="el" href="device__sessionfs__mod_8h.html#ade57e23a26963004ebf1cbcc05b825ed" title="Keeps the path to the directory in which session sematic is enabled (located in ::device_sessionfs....">sess_path</a></code> is copied in the provided buffer.</p>
<p>When a write operation is issued the <code><a class="el" href="device__sessionfs_8c.html#a2d6bff2892b490d459e42974bfd4be12" title="Writes a new path in which sessions must be enabled.">device_write()</a></code> is called and, after checking that the provided path is an absolute one, the <code><a class="el" href="device__sessionfs__mod_8h.html#ade57e23a26963004ebf1cbcc05b825ed" title="Keeps the path to the directory in which session sematic is enabled (located in ::device_sessionfs....">sess_path</a></code> buffer is reset and overwritten with the new content, also updating the <code><a class="el" href="device__sessionfs_8c.html#a0795adbd1769bd5aa787af11b811c556" title="Length of the of the path string.">path_len</a></code> variable.</p>
<p>When an ioctl operation is issued the <code><a class="el" href="device__sessionfs_8c.html#a72e3cac371d57c08b7a62d2cb9e13fb3" title="Handles the ioctls calls issued to the SessionFS_dev device.">device_ioctl()</a></code> is called and, according to the parameters, a session can be created with <code><a class="el" href="session__manager_8c.html#ae86586f2293bf35b1b57be58af0b9588" title="Create a new session for the specified file.">create_session()</a></code>, closed with <code><a class="el" href="session__manager_8c.html#a1594b401bd3a9bb39decd88759bfbebd" title="Closes a session.">close_session()</a></code> or a device shutdown can be requested.</p>
<p>If a device shutdown is requested the device checks if the dependency introduced during the <code><a class="el" href="device__sessionfs_8c.html#a88bd4adb20dc9040ae78f5b4036b61ab" title="Device initialization and registration.">init_device()</a></code> should be removed; this happens only if the <code><a class="el" href="device__sessionfs_8c.html#a9b74fe6d4d3e403eb54f84a6310bfbf8" title="Refcount of the processes that are using the device.">refcount</a></code> is 0 and the <em>Session Manager</em> submodule has no sessions that are active or in use by SysFS.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Session Manager</h3>
<p>The <em>Session Manager</em> submodule (<a class="el" href="session__manager_8c.html" title="Implementation of the Session Manager submodule.">session_manager.c</a>) is initialized by the <em>Character Device</em> submodule, when <code><a class="el" href="session__manager_8c.html#abd67495092f6edf4b7e5b6ae94be3154" title="Initialization of the session manager data structures.">init_manager()</a></code> is called.</p>
<p>Then the <em>Character Device</em> can call <code><a class="el" href="session__manager_8c.html#ae86586f2293bf35b1b57be58af0b9588" title="Create a new session for the specified file.">create_session()</a></code> or <code><a class="el" href="session__manager_8c.html#a1594b401bd3a9bb39decd88759bfbebd" title="Closes a session.">close_session()</a></code> according the parameters passed in the received ioctl.</p>
<p>When <code><a class="el" href="session__manager_8c.html#ae86586f2293bf35b1b57be58af0b9588" title="Create a new session for the specified file.">create_session()</a></code> is called, a <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> with the given <code>pathname</code> is searched (with <code><a class="el" href="session__manager_8c.html#abe5de8d0745f9cc09c02191e1818001f" title="Searches for a session with a given pathname, or with an incarnation with matching pid and file descr...">search_session()</a></code>) and if nothing valid is found a new object is created with <code><a class="el" href="session__manager_8c.html#abe3ac55880f2af28017214c50a38d487" title="Initializes the session information for the given pathname.">init_session()</a></code>. Then the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code> object will be created with <code><a class="el" href="session__manager_8c.html#a2c676ca524171b7f600b7f0189266167" title="Creates an incarnation and add it to an existing session.">create_incarnation()</a></code>. The original file is opened during the <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> creation, without a file descriptor associated. The incarnation file is opened during the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code> creation with an associated file descriptor which will be used by the userspace program. <code><a class="el" href="session__manager_8c.html#a2dd653e4fa6e0dd5f0b4ea3d697679d8" title="Opens a file from kernel space.">open_file()</a></code> is used to open both files.</p>
<p>When <code><a class="el" href="session__manager_8c.html#a1594b401bd3a9bb39decd88759bfbebd" title="Closes a session.">close_session()</a></code> is called, the parent <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> of the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code> is located using <code><a class="el" href="session__manager_8c.html#abe5de8d0745f9cc09c02191e1818001f" title="Searches for a session with a given pathname, or with an incarnation with matching pid and file descr...">search_session()</a></code>, then the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code> is deleted using <code><a class="el" href="session__manager_8c.html#a18273cf2fcf61730e36b611412c0700d" title="Removes the given incarnation.">delete_incarnation()</a></code>. The original file is overwritten only if the parent <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> is a valid one. If, after removing the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code>, the parent <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> is empty and unused, it will be marked as invalid and removed as soon as possible.</p>
<p>This module also contains a primitive "garbage collector", the <code><a class="el" href="session__manager_8c.html#a96edb8992f8537a88c79b896b45d47c2" title="Releases all the incarnations that are associated with a dead/zombie pid.">clean_manager()</a></code> function, which will walk though all the sessions and will delete the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code> associated with a process which is dead or in a zombie state, returning the number of sessions associated with an alive process. This function is used in the <em>Device Module</em> to determine if there are active sessions and thus if the module should remain locked even if no process is using the device at the moment.</p>
<p>The deletion of the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code> objects is not immediate, since after removing its info on SysFS there could be processes with a reference on the related pseudofiles. So the object is marked as invalid and will be deallcoated along with the corresponding session object, when this is not in use.</p>
<h3><a class="anchor" id="autotoc_md12"></a>
Session Information</h3>
<p>The <em>Session Information</em> (<a class="el" href="session__info_8c.html" title="Implementation of the Session Information submodule.">session_info.c</a>) handles the publishing of the information on the session via SysFS, so it needs to be initialized with the kernel object of the <code>SessionFS_dev</code> device, using <code><a class="el" href="session__info_8c.html#a312e0fdf08fa3f8c529ac615d7688727" title="Initializes the SessionFS kobject with general information about the running sessions.">init_info()</a></code>. Conversely, when the device is being released the kernel attribute used to publish the active sessions (<code><a class="el" href="session__info_8c.html#a96baf900f57fd912e3c3fd6619d4eefd" title="The kernel attribute that will contain the number of open sessions.">kattr</a></code>) needs to be removed from the kernel object of the device, using <code><a class="el" href="session__info_8c.html#a8f45995b8b183511354096a9c2063d8d" title="Removes the SessionFS information from the device provided in init_info().">release_info()</a></code>.</p>
<p>When an <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> is created by the <em>Session Manager</em> submodule, the function <code><a class="el" href="session__info_8c.html#a5c06075650f0014909ac3ed682ff71aa" title="Adds a new kobject representing an original file, under the SessionFS kobject.">add_session_info()</a></code> is called, which creates a new subfolder in the <code>SessionFS_dev</code> device folder and adds an <code>active_incarnations_num</code> pseudofile in it. Conversely when a session is removed, the function <code><a class="el" href="session__info_8c.html#a49532cff908aa827fb90e1d4e3dcd2b0" title="Removes the kobject attribute incarnation from a kobject.">remove_incarnation_info()</a></code> is called removing the pseudofile and the folder.</p>
<p>Similarly, when an <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code> is created by the <em>Session Manager</em> submodule the function <code><a class="el" href="session__info_8c.html#a05e60807f715e0eee172cc7f4f58aec7" title="Adds a new kobject attribute representing an incarnation.">add_incarnation_info()</a></code> is called, which creates a new pseudofile in the parent <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code>, that has as filename the pid of the process which owns the <code><a class="el" href="structincarnation.html" title="Informations on an incarnation of a file.">incarnation</a></code>, and gives the process name when read. Then the parent <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> <code>inc_num</code> variable, contained in the <code><a class="el" href="structsess__info.html" title="Infromations on a session used by SysFS.">sess_info</a></code> struct associated with the <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> object, is incremented. This variable is accessed when the <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> <code>active_incarnations_num</code> file is read. Conversely when an incarnation is removed, the function <code><a class="el" href="session__info_8c.html#a49532cff908aa827fb90e1d4e3dcd2b0" title="Removes the kobject attribute incarnation from a kobject.">remove_incarnation_info()</a></code> is called removing the pseudofile and decrementing the parent <code><a class="el" href="structsession.html" title="General information on a session.">session</a></code> <code>inc_num</code> variable.</p>
<h1><a class="anchor" id="autotoc_md13"></a>
Testcase and Benchmark</h1>
<p>The module was tested on the latest long-term support kernel (which is 5.4 at the moment) and can be loaded and unloaded freely. However there could be situations in which the module cannot be unloaded, this is due to the fact the device is in use or there are sessions which are being used by active processes.</p>
<p>In particular there is a situation in which there are no active session and the module could be unloadable, this happens because the device requires an explicit ioctl to clean up the <em>Session Manager</em> submodule and unlock the module, if possible.0</p>
<p>The userspace program (<a class="el" href="userspace__test_8c.html" title="Userpsace program that will test the kernel module using the libsessionfs.c shared library.">userspace_test.c</a>) is composed of four utility functions and the main, which will use them to carry out tests:</p><ul>
<li><code><a class="el" href="userspace__test_8c.html#a8fb0a3225a9c074550158687a7f46cb2" title="Use libsessionfs APIs to change the session path to path.">change_sess_path()</a></code>: changes the session path using the utility function provided by the shared userspace library.</li>
<li><code><a class="el" href="userspace__test_8c.html#a1de5516a7893ff3ea277a8c976417bd7" title="A general functionality test.">func_test()</a></code>: tests the module functionalities in a per-process perspective.</li>
<li><code><a class="el" href="userspace__test_8c.html#afa4dca6f8131bb0e05d21abae9f807d1" title="Test file semantic with a session opened when forking.">fork_test()</a></code>: tests that the file semantic using session is the same when forking with opened sessions.</li>
<li><p class="startli"><code><a class="el" href="userspace__test_8c.html#a3c04138a5bfe5d72780bb7e82a18e627" title="Testing of the kernel module.">main()</a></code>: executes the tests for a use-case defined by the parameters passed when running the program.</p>
<p class="startli">To use the program two parameters are required, in the following order:</p><ol type="1">
<li>the maximum number of processes;</li>
<li>the maximum number of files used by each process;</li>
</ol>
</li>
</ul>
<p>Tests have been conducted on four different use-cases, each of these use-cases is available to be used in the makefile under the <code>test</code> directory:</p>
<ol type="1">
<li>A single process which can open up to 15 files using sessions.</li>
<li>A single process which can open up to 100 file using sessions.</li>
<li>Up to 15 processes, where each of them can open up to 15 file using sessions.</li>
<li>Up to 100 processes, where each of them can open up to 100 file using sessions.</li>
</ol>
<p>The single process use case are very quick and straightforward and were generally used to locate errors which made the module unusable. Instead the multi process test were designed to test how test how the module responds when there are many processes that use it and were used to locate errors in critical sections.</p>
<p>Tests were conducted initially in a virtualized enviroment on a kernel with debug features enabled, which has provided a mean to debug errors swiftly, without having to restart the machine each time there was a crash. When everything was functional on the virtual machine tests have been moved on the live environment. In particular we can see, especially in the use-case 4, that stress tests are lengthy since the processes can randomly sleep and they write a great amount of data to disk, in the use-case 4 more than 2GB can be written on disk. Tests completed successfully without errors and the kernel module responded swiftly and in the correct way when invoked. By examining the files we can see that the semantic of the Unix sessions is respected, since there are file that are completely overwritten and we can also see the interleaving of pids when processes append their content instead of overwriting.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Makefile organization</h1>
<p>In the repository there are several makefiles, that execute operations with several levels of detail and where the "outer" makefiles user the "inner" makefile targets to execute its operations:</p><ul>
<li>In the root directory of the repository the makefile has only three targets:<ul>
<li><code>src</code>: which builds the source code for the kernel module, the shared library and the userspace program.</li>
<li><code>docs</code>: which generates the documentation (including this report) in html and LaTeX in <code>docs/doxygen</code>.</li>
<li><code>clean</code>: which will clean the repository from all the files that are generated by the above targets, excluding the pdf and html formats of the documentation.</li>
</ul>
</li>
<li>In the <code>src</code> directory the makefile has four targets:<ul>
<li><code>module</code>: which will build the kernel module.</li>
<li><code>shared-lib</code>: which will build the userspace shared library.</li>
<li><code>demo-lib</code>: which will build the userspace program.</li>
<li><code>clean</code>: which will clean the repository from all the files that are generated by the above targets.</li>
</ul>
</li>
<li>In the <code>kmodule</code> directory the makefile has four targets:<ul>
<li><code>all</code>: which will build the kernel module.</li>
<li><code>insmod</code>: which will run <code>dmesg -C</code> and insert the kernel module in the kernel with <code>insmod</code>.</li>
<li><code>rmmod</code>: which will unload the module and kill <code>dmesg</code> if it is running.</li>
<li><code>clean</code>: which will clean the repository from all the files that are generated by the above targets.</li>
</ul>
</li>
<li>In the <code>shared_lib</code> folder the makefile has only three targets:<ul>
<li><code>libsessionfs</code>: which will build the shared library.</li>
<li><code>libsessionfs-d</code>: which will build the shared library enabling address sanitizer and the gdb debug options.</li>
<li><code>clean</code>: which will clean the repository from all the files that are generated by the above target.</li>
</ul>
</li>
<li>In the <code>demo</code> folder the makefile has three targets:<ul>
<li><code>demo-lib-d</code>: which will compile,the userspace program enabling address sanitizer and the gdb debug options.</li>
<li><code>demo-lib</code>: which will compile the userspace program linking it with the userspace shared library.</li>
<li><code>clean</code>: which will clean the repository from all the files that are generated by the above target.</li>
</ul>
</li>
<li>In the <code>test</code> folder there are five targets:<ul>
<li><code>lib-test-single</code>: which will execute the use-case 1.</li>
<li><code>lib-stress-test-single</code>: which will execute the use-case 2.</li>
<li><code>lib-test-multi</code>: which will execute the use-case 3.</li>
<li><code>lib-stress-test-multi</code>: which will execute the use-case 4.</li>
<li><code>clean</code>: which will clean the repository from all the files that are generated by the above target, excluding log files. </li>
</ul>
</li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
